name: CI/CD - Deploy Frontend

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install Dependencies
        run: npm install

      - name: Run Build
        run: npm run build

      - name: Deploy Frontend with PM2
        shell: powershell
        run: |
          echo "Deploying Frontend..."

          $FRONTEND_DIR = "E:/actions-runner-frontend/_work/projeto-gerador-ideias-frontend/projeto-gerador-ideias-frontend"
          $BACKEND_DIR = "E:/actions-runner/_work/projeto-gerador-ideias-backend/projeto-gerador-ideias-backend"
          $PM2_PATH = "C:\Users\marco.filho\AppData\Roaming\npm\pm2.ps1"

          echo "Removendo dist antigo..."
          Remove-Item -Path "$FRONTEND_DIR/dist" -Recurse -Force -ErrorAction SilentlyContinue

          echo "Copiando novo dist..."
          Copy-Item -Path "$env:GITHUB_WORKSPACE/dist" -Destination "$FRONTEND_DIR/" -Recurse -Force

          cd $BACKEND_DIR

          & $PM2_PATH startOrRestart "ecosystem.config.js" --only CriaitorFrontend
          & $PM2_PATH save

          echo "Frontend deploy finalizado!"
