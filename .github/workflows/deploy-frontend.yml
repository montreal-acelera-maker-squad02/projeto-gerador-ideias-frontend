name: CI/CD - Deploy Frontend

on:

  push:

    branches:

      - main

jobs:

  build-and-deploy:

    runs-on: self-hosted
    steps:

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js 20.x
        uses: actions/setup-node@v4

        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install Dependencies
        run: npm install

      - name: Run Build (Generate 'dist')
        run: npm run build

      - name: Deploy Local PM2 Restart
        run: |

          echo "Deploying Frontend to VM..."
          
          $FRONTEND_DIR = "E:/Criaitor/projeto-gerador-ideias-frontend"

          $BACKEND_DIR = "E:/Criaitor/projeto-gerador-ideias-backend"

          $PM2_PATH = "C:\Users\marco.filho\AppData\Roaming\npm\pm2.ps1"

          cp -r dist $FRONTEND_DIR/

          cd $BACKEND_DIR

          & $PM2_PATH startOrRestart ecosystem.config.js --name CriaitorFrontend
          & $PM2_PATH save

          echo "Frontend Deployment successful."